<plugin>
    <script>
        // Windy API modules are imported via '@windy/nameOfModule'
        import map from '@windy/map';
        // custom marker for disturbance
        const MARKER = encodeURIComponent("<svg xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' style='margin:auto;background:rgba(160, 88, 181,0);display:block;' width='200px' height='200px' viewBox='0 0 100 100' preserveAspectRatio='xMidYMid'><circle cx='50' cy='50' r='0' fill='none' stroke='#e90c59' stroke-width='17'>  <animate attributeName='r' repeatCount='indefinite' dur='1s' values='0;26' keyTimes='0;1' keySplines='0 0.2 0.8 1' calcMode='spline' begin='-0.5s'></animate>  <animate attributeName='opacity' repeatCount='indefinite' dur='1s' values='1;0' keyTimes='0;1' keySplines='0.2 0 0.8 1' calcMode='spline' begin='-0.5s'></animate></circle><circle cx='50' cy='50' r='0' fill='none' stroke='#46dff0' stroke-width='17'>  <animate attributeName='r' repeatCount='indefinite' dur='1s' values='0;26' keyTimes='0;1' keySplines='0 0.2 0.8 1' calcMode='spline'></animate>  <animate attributeName='opacity' repeatCount='indefinite' dur='1s' values='1;0' keyTimes='0;1' keySplines='0.2 0 0.8 1' calcMode='spline'></animate></circle></svg>");
        const MARKER_URL = `data:image/svg+xml;utf8,${MARKER}`;
        const Icon = L.icon({
            iconUrl: MARKER_URL,
            iconSize: [48, 48],
            iconAnchor: [24, 24],
            popupAnchor: [0, 0],
        });
        const MARKER_DOT = encodeURIComponent("<svg height='480pt' viewBox='0 0 480 480' width='480pt' xmlns='http://www.w3.org/2000/svg'><path d='m432 240c0 106.039062-85.960938 192-192 192s-192-85.960938-192-192 85.960938-192 192-192 192 85.960938 192 192zm0 0' fill='#cfd2fc'/><path d='m240 480c-132.546875 0-240-107.453125-240-240s107.453125-240 240-240 240 107.453125 240 240c-.148438 132.484375-107.515625 239.851562-240 240zm0-464c-123.710938 0-224 100.289062-224 224s100.289062 224 224 224 224-100.289062 224-224c-.140625-123.652344-100.347656-223.859375-224-224zm0 0' fill='#8690fa'/><path d='m352 240c0 61.855469-50.144531 112-112 112s-112-50.144531-112-112 50.144531-112 112-112 112 50.144531 112 112zm0 0' fill='#5153ff'/></svg>");
        const MARKER_DOT_URL = `data:image/svg+xml;utf8,${MARKER_DOT}`;
        const Icon_Dot = L.icon({
            iconUrl: MARKER_DOT_URL,
            iconSize: [16, 16],
            iconAnchor: [8, 8],
            popupAnchor: [0, 0],
        });
        // url of datas | default = https://www.nrlmry.navy.mil/tcdat/sectors/ftp_sector_file
        let url = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ6jEPD4JLNsppgMJ4wB8k4hpVHzc-8VKAkoQDwfMgeHHd18N3AEUhj8wbAgrCbKJiFzWGz_ZF0LkpV/pub?gid=0&single=true&output=csv"
        let active_disturbance = [];
        let disturbance = L.layerGroup();
        let latlon_all = [];
        Papa.parse(url, {
            download: true,
            complete: function (results) {
                //number of distrubance
                let ln = 0;
                let nb_ln;
                for (nb_ln in results.data) {
                    ln++;
                }
                console.log('Search disturbance...');
                console.log(ln + " disturbance.s detected.");
                for (let i = 0; i < ln; i++) {
                    let str = results.data[i][0];
                    let pattern_nrl = "([0-9]{1,2})(S|A|B|L|C|E|W|P)\\s+(\\w+)\\s([0-9]{1,2})([0-9]{1,2})([0-9]{1,2})\\s([0-9]{1,2})([0-9]{1,2})\\s+([0-9]{1,2}.[0-9]{1})(S|N)\\s+([0-9]{1,3}.[0-9]{1})(E|W)\\s(SHEM|IO|ATL|WPAC|CPAC|EPAC)\\s+([0-9]{1,3})\\s+([0-9]{1,4})|(NA)";
                    let out = str.match(pattern_nrl);
                    let nb = out[1] + out[2]
                    let lat;
                    let lon;
                    //Select the hemisphere
                    if (out[10] == 'S') {
                        lat = "-" + out[9];
                    } else {
                        lat = out[9];
                    }
                    if (out[12] == 'W') {
                        lon = "-" + out[11];
                    } else {
                        lon = out[11];
                    }
                    let date = "20" + out[4] + "/" + out[5] + "/" + out[6] + " " + out[7] + ":" + out[8];
                    let name = out[3];
                    let pressure = out[15];
                    let wind = out[14];
                    L.marker({ lat, lon }, { icon: Icon }).bindPopup("<b>Date/time</b>:" + date + " <br><b>N°</b>: " + nb + "<br><b>Name</b>: " + name + "<br><b>Pressure</b>: " + pressure + " hPa<br><b>Wind(knots)</b>: " + wind).addTo(disturbance);
                    active_disturbance.push(nb + "." + name);
                }
                console.log(active_disturbance);
            }

        });
        let url_line = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ6jEPD4JLNsppgMJ4wB8k4hpVHzc-8VKAkoQDwfMgeHHd18N3AEUhj8wbAgrCbKJiFzWGz_ZF0LkpV/pub?gid=966820877&single=true&output=csv"
        Papa.parse(url_line, {
            download: true,
            complete: function (results_line) {
                let disturbances = {};
                let ln = 0;
                let nb_ln;
                for (nb_ln in results_line.data) {
                    ln++;
                }
                let year = new Date().getFullYear();
                let today = new Date();


                function dayDiff(d1, d2) {
                    d1 = d1.getTime() / 86400000;
                    d2 = d2.getTime() / 86400000;
                    return new Number(d2 - d1).toFixed(0);
                }
                for (let i = 0; i < ln; i++) {
                    let latlon = [];
                    let str = results_line.data[i][0];
                    let parttern_line = "([0-9]{1,2})(S|A|B|L|C|E|W|P)\\s+(\\w+)\\s([0-9]{1,2})([0-9]{1,2})([0-9]{1,2})\\s([0-9]{1,2})([0-9]{1,2})\\s+([0-9]{1,2}.[0-9]{1})(S|N)\\s+([0-9]{1,3}.[0-9]{1})(E|W)\\s(SHEM|IO|ATL|WPAC|CPAC|EPAC)\\s+([0-9]{1,3})\\s+([0-9]{1,4})|(NA)";
                    let out_l = str.match(parttern_line);
                    let lon_name = out_l[1] + out_l[2] + "." + out_l[3];
                    if (active_disturbance.includes(lon_name)) {
                        let lat;
                        let lon;
                        let nb = out_l[1] + out_l[2]
                        if (out_l[10] == 'S') {
                            lat = "-" + out_l[9];
                        } else {
                            lat = out_l[9];
                        }
                        if (out_l[12] == 'W') {
                            lon = "-" + out_l[11];
                        } else {
                            lon = out_l[11];
                        }
                        let date = new Date("20" + out_l[4] + "/" + out_l[5] + "/" + out_l[6] + " " + out_l[7] + ":" + out_l[8]);
                        let hour = out_l[6] + ":" + out_l[7];
                        let name = out_l[3];
                        let pressure = out_l[15];
                        let wind = out_l[14];
                        L.marker({ lat, lon }, { icon: Icon_Dot }).bindPopup("<b>Date/time</b>:" + date + " <br><b>N°</b>: " + nb + "<br><b>Name</b>: " + name + "<br><b>Pressure</b>: " + pressure + " hPa<br><b>Wind(knots)</b>: " + wind).addTo(disturbance);
                        if (name in disturbances) {
                                //disturbances[name].push(new Array(name, date, hour, lat, lon, pressure, wind));
                                disturbances[name].push(new Array(parseFloat(lat), parseFloat(lon)));
                            } else {
                                disturbances[name] = [];
                                //disturbances[name].push(new Array(name, date, hour, lat, lon, pressure, wind));
                                disturbances[name].push(new Array(parseFloat(lat), parseFloat(lon)));
                            }
                    }
                }

                    let arr = Object.values(disturbances);
                    L.polyline(arr, { color: 'red' }).addTo(disturbance);
            }
        })
        this.onopen = () => {
            disturbance.addTo(map);
        }

        this.onclose = () => {
            map.removeLayer(disturbance);
        }

    </script>
</plugin>
